generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model ContractVehicle {
  id              String   @id
  name            String
  description     String?
  agency          String?
  piidPrefix      String?  @map("piid_prefix")
  taskOrderCount  Int      @default(0) @map("task_order_count")
  totalObligated  Float    @default(0) @map("total_obligated")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  taskOrders TaskOrder[]

  @@map("contract_vehicles")
}

model TaskOrder {
  id                          Int       @id @default(autoincrement())
  piid                        String
  parentIdvPiid               String?   @map("parent_idv_piid")
  vehicleId                   String?   @map("vehicle_id")
  vehicleName                 String?   @map("vehicle_name")

  // Vendor information
  vendorName                  String?   @map("vendor_name")
  vendorUei                   String?   @map("vendor_uei")
  cageCode                    String?   @map("cage_code")

  // Award details
  awardDescription            String?   @map("award_description")
  productOrServiceDescription String?   @map("product_or_service_description")
  naicsDescription            String?   @map("naics_description")

  // Dates
  awardDate                   String?   @map("award_date")
  periodOfPerformanceStart    String?   @map("period_of_performance_start")
  periodOfPerformanceEnd      String?   @map("period_of_performance_end")

  // Financial
  obligatedAmount             Float?    @map("obligated_amount")
  baseAndExercisedValue       Float?    @map("base_and_exercised_value")
  potentialValue              Float?    @map("potential_value")

  // Classification codes
  naicsCode                   String?   @map("naics_code")
  pscCode                     String?   @map("psc_code")

  // Agencies
  awardingAgency              String?   @map("awarding_agency")
  fundingAgency               String?   @map("funding_agency")

  // Location
  placeOfPerformanceState     String?   @map("place_of_performance_state")
  placeOfPerformanceCountry   String?   @map("place_of_performance_country")

  // Metadata
  lastModifiedDate            String?   @map("last_modified_date")
  createdAt                   DateTime  @default(now()) @map("created_at")

  // Full-text search (managed via raw SQL, kept for schema sync)
  searchText                  Unsupported("tsvector")? @map("search_text")

  // Relation
  vehicle                     ContractVehicle? @relation(fields: [vehicleId], references: [id])

  @@index([vehicleId])
  @@index([vendorName])
  @@index([awardDate])
  @@index([piid])
  @@index([obligatedAmount])
  @@map("task_orders")
}

model SearchJob {
  id              Int       @id @default(autoincrement())
  query           String
  status          String    @default("pending") // pending, running, completed, failed
  internalCount   Int       @default(0) @map("internal_count")
  externalCount   Int       @default(0) @map("external_count")
  newRecords      Int       @default(0) @map("new_records")
  externalResults Json?     @map("external_results") // Cached external results for display
  error           String?
  createdAt       DateTime  @default(now()) @map("created_at")
  completedAt     DateTime? @map("completed_at")

  @@map("search_jobs")
}

// ============================================================================
// Budget Analytics Models
// ============================================================================

model BudgetLineItem {
  id                  Int       @id @default(autoincrement())
  fiscalYear          Int       @map("fiscal_year")
  appropriationType   String    @map("appropriation_type") // RDT&E, Procurement, O&M
  agency              String?
  service             String?
  programElement      String?   @map("program_element")
  lineItemNumber      String?   @map("line_item_number")
  programName         String?   @map("program_name")

  // Funding amounts (in thousands of dollars)
  priorYearActual     Decimal?  @map("prior_year_actual") @db.Decimal(15, 2)
  currentYearEnacted  Decimal?  @map("current_year_enacted") @db.Decimal(15, 2)
  budgetYearRequest   Decimal?  @map("budget_year_request") @db.Decimal(15, 2)
  outyear1            Decimal?  @map("outyear_1") @db.Decimal(15, 2)
  outyear2            Decimal?  @map("outyear_2") @db.Decimal(15, 2)
  outyear3            Decimal?  @map("outyear_3") @db.Decimal(15, 2)
  outyear4            Decimal?  @map("outyear_4") @db.Decimal(15, 2)
  outyear5            Decimal?  @map("outyear_5") @db.Decimal(15, 2)

  sourceDocumentUrl   String?   @map("source_document_url")
  extractedAt         DateTime  @default(now()) @map("extracted_at")

  narratives          BudgetNarrative[]

  @@unique([fiscalYear, programElement, lineItemNumber, agency])
  @@index([fiscalYear])
  @@index([agency])
  @@index([programElement])
  @@index([appropriationType])
  @@map("budget_line_items")
}

model BudgetNarrative {
  id            Int       @id @default(autoincrement())
  lineItemId    Int       @map("line_item_id")
  narrativeType String?   @map("narrative_type") // mission, accomplishments, changes
  content       String?   @db.Text
  aiSummary     String?   @map("ai_summary") @db.Text
  extractedAt   DateTime  @default(now()) @map("extracted_at")

  lineItem      BudgetLineItem @relation(fields: [lineItemId], references: [id], onDelete: Cascade)

  @@index([lineItemId])
  @@map("budget_narratives")
}

model BudgetDocument {
  id            Int       @id @default(autoincrement())
  fiscalYear    Int       @map("fiscal_year")
  agency        String?
  documentType  String?   @map("document_type")
  url           String
  filename      String?
  fileHash      String?   @map("file_hash")
  localPath     String?   @map("local_path")
  crawledAt     DateTime? @map("crawled_at")
  parsedAt      DateTime? @map("parsed_at")
  status        String    @default("pending") // pending, downloaded, parsed, failed
  errorMessage  String?   @map("error_message") @db.Text

  @@index([fiscalYear])
  @@index([status])
  @@index([agency])
  @@map("budget_documents")
}

model BudgetTrend {
  id                Int       @id @default(autoincrement())
  programElement    String?   @map("program_element")
  programName       String?   @map("program_name")
  fiscalYear        Int       @map("fiscal_year")
  agency            String?
  appropriationType String?   @map("appropriation_type")
  amount            Decimal?  @db.Decimal(15, 2)
  yoyChangeDollars  Decimal?  @map("yoy_change_dollars") @db.Decimal(15, 2)
  yoyChangePercent  Decimal?  @map("yoy_change_percent") @db.Decimal(8, 2)
  fiveYearCagr      Decimal?  @map("five_year_cagr") @db.Decimal(8, 2)
  trendDirection    String?   @map("trend_direction") // up, down, flat, new, terminated

  @@unique([programElement, fiscalYear, agency, appropriationType])
  @@index([trendDirection, fiscalYear])
  @@index([yoyChangePercent(sort: Desc)])
  @@index([fiscalYear])
  @@map("budget_trends")
}

// ============================================================================
// Contract Waste Screener Models
// ============================================================================

model ServiceContract {
  id                      Int       @id @default(autoincrement())
  piid                    String    @unique
  parentIdvPiid           String?   @map("parent_idv_piid")

  // Award details
  awardDescription        String?   @map("award_description") @db.Text
  awardType               String?   @map("award_type")
  contractType            String?   @map("contract_type")

  // Dates
  awardDate               DateTime? @map("award_date")
  periodOfPerformanceStart DateTime? @map("period_of_performance_start")
  periodOfPerformanceEnd   DateTime? @map("period_of_performance_end")

  // Financial
  baseValue               Decimal?  @map("base_value") @db.Decimal(15, 2)
  currentValue            Decimal?  @map("current_value") @db.Decimal(15, 2)
  obligatedAmount         Decimal?  @map("obligated_amount") @db.Decimal(15, 2)
  awardCeiling            Decimal?  @map("award_ceiling") @db.Decimal(15, 2)

  // Classification
  naicsCode               String?   @map("naics_code")
  naicsDescription        String?   @map("naics_description")
  pscCode                 String?   @map("psc_code")
  pscDescription          String?   @map("psc_description")

  // Vendor
  vendorName              String?   @map("vendor_name")
  vendorUei               String?   @map("vendor_uei")
  vendorCageCode          String?   @map("vendor_cage_code")

  // Organization
  contractingOfficeId     Int?      @map("contracting_office_id")
  contractingOfficeName   String?   @map("contracting_office_name")
  awardingAgency          String?   @map("awarding_agency")
  awardingSubAgency       String?   @map("awarding_sub_agency")
  fundingAgency           String?   @map("funding_agency")
  fundingSubAgency        String?   @map("funding_sub_agency")

  // Location
  placeOfPerformanceState String?   @map("place_of_performance_state")
  placeOfPerformanceCountry String? @map("place_of_performance_country")

  // Metadata from USASpending
  usaspendingAwardId      String?   @map("usaspending_award_id")
  lastModifiedDate        DateTime? @map("last_modified_date")

  // Timestamps
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  // Relations
  modifications           ContractModification[]
  subawards               Subaward[]
  wasteScore              WasteScore?
  riskScore               ContractRiskScore?
  costObservations        ContractCostObservation[]
  contractingOffice       DoDOrganization? @relation(fields: [contractingOfficeId], references: [id])

  @@index([vendorUei])
  @@index([vendorName])
  @@index([naicsCode])
  @@index([pscCode])
  @@index([awardingAgency])
  @@index([awardDate])
  @@index([contractingOfficeId])
  @@map("service_contracts")
}

model ContractModification {
  id                Int       @id @default(autoincrement())
  contractId        Int       @map("contract_id")
  modificationNumber String?  @map("modification_number")
  actionDate        DateTime? @map("action_date")
  actionType        String?   @map("action_type")
  description       String?   @db.Text
  obligatedChange   Decimal?  @map("obligated_change") @db.Decimal(15, 2)
  obligatedTotal    Decimal?  @map("obligated_total") @db.Decimal(15, 2)

  createdAt         DateTime  @default(now()) @map("created_at")

  contract          ServiceContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([actionDate])
  @@map("contract_modifications")
}

model Subaward {
  id                      Int       @id @default(autoincrement())
  contractId              Int       @map("contract_id")
  subawardNumber          String?   @map("subaward_number")
  subawardAmount          Decimal?  @map("subaward_amount") @db.Decimal(15, 2)
  subcontractorName       String?   @map("subcontractor_name")
  subcontractorUei        String?   @map("subcontractor_uei")
  subcontractorCageCode   String?   @map("subcontractor_cage_code")
  description             String?   @db.Text
  actionDate              DateTime? @map("action_date")
  placeOfPerformanceState String?   @map("place_of_performance_state")

  createdAt               DateTime  @default(now()) @map("created_at")

  contract                ServiceContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([subcontractorUei])
  @@map("subawards")
}

model WasteScore {
  id                  Int       @id @default(autoincrement())
  contractId          Int       @unique @map("contract_id")

  // Individual waste signals (0-100 each)
  costGrowthPct       Decimal?  @map("cost_growth_pct") @db.Decimal(8, 2)
  ceilingUtilization  Decimal?  @map("ceiling_utilization") @db.Decimal(8, 2)
  contractAgeDays     Int?      @map("contract_age_days")
  modificationCount   Int?      @map("modification_count")
  passThruRatio       Decimal?  @map("pass_thru_ratio") @db.Decimal(8, 2)
  vendorConcentration Int?      @map("vendor_concentration")
  duplicateRisk       Decimal?  @map("duplicate_risk") @db.Decimal(8, 2)
  impliedHourlyRate   Decimal?  @map("implied_hourly_rate") @db.Decimal(10, 2)

  // Composite score
  overallScore        Decimal?  @map("overall_score") @db.Decimal(8, 2)

  // Flags for quick filtering
  flagCostGrowth      Boolean   @default(false) @map("flag_cost_growth")
  flagUnderutilized   Boolean   @default(false) @map("flag_underutilized")
  flagOldContract     Boolean   @default(false) @map("flag_old_contract")
  flagHighMods        Boolean   @default(false) @map("flag_high_mods")
  flagPassThru        Boolean   @default(false) @map("flag_pass_thru")
  flagVendorConc      Boolean   @default(false) @map("flag_vendor_conc")
  flagDuplicate       Boolean   @default(false) @map("flag_duplicate")
  flagHighRate        Boolean   @default(false) @map("flag_high_rate")

  calculatedAt        DateTime  @default(now()) @map("calculated_at")

  contract            ServiceContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([overallScore(sort: Desc)])
  @@index([flagCostGrowth])
  @@index([flagPassThru])
  @@map("waste_scores")
}

model DoDOrganization {
  id                Int       @id @default(autoincrement())
  code              String?   @unique
  name              String
  level             String?   // agency, command, office
  parentId          Int?      @map("parent_id")

  createdAt         DateTime  @default(now()) @map("created_at")

  parent            DoDOrganization?  @relation("OrgHierarchy", fields: [parentId], references: [id])
  children          DoDOrganization[] @relation("OrgHierarchy")
  contracts         ServiceContract[]

  @@index([parentId])
  @@index([level])
  @@map("dod_organizations")
}

// ============================================================================
// Risk Model (Black-Scholes Cost Risk)
// ============================================================================

enum ConfidenceLevel {
  high   // 50+ observations
  medium // 20-49 observations
  low    // <20 observations
}

model VolatilityParameter {
  id                Int       @id @default(autoincrement())
  pscCode           String    @map("psc_code")
  agencyCode        String?   @map("agency_code")
  sigma             Decimal   @db.Decimal(8, 4) // Annualized volatility (e.g., 0.2500 = 25%)
  observationCount  Int       @map("observation_count")
  confidenceLevel   ConfidenceLevel @map("confidence_level")
  lastCalculated    DateTime  @map("last_calculated")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@unique([pscCode, agencyCode])
  @@index([pscCode])
  @@index([confidenceLevel])
  @@map("volatility_parameters")
}

model ContractRiskScore {
  id                      Int       @id @default(autoincrement())
  contractId              Int       @unique @map("contract_id")

  // Current state
  currentRatio            Decimal   @map("current_ratio") @db.Decimal(8, 4)
  impliedVolatility       Decimal   @map("implied_volatility") @db.Decimal(8, 4)
  lifecycleStage          Int       @map("lifecycle_stage") // 0-100 percent complete
  lifecycleMultiplier     Decimal   @map("lifecycle_multiplier") @db.Decimal(4, 2)

  // Outputs
  riskScore               Int       @map("risk_score") // 0-100
  expectedCostLow         Decimal?  @map("expected_cost_low") @db.Decimal(15, 2) // 10th percentile
  expectedCostMid         Decimal?  @map("expected_cost_mid") @db.Decimal(15, 2) // 50th percentile
  expectedCostHigh        Decimal?  @map("expected_cost_high") @db.Decimal(15, 2) // 90th percentile
  ceilingBreachProb       Decimal   @map("ceiling_breach_prob") @db.Decimal(5, 2) // 0-100%
  monthsToWarning         Int?      @map("months_to_warning")

  // Confidence from underlying volatility parameter
  confidenceLevel         ConfidenceLevel @map("confidence_level")

  calculatedAt            DateTime  @map("calculated_at")
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  contract                ServiceContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([riskScore(sort: Desc)])
  @@index([ceilingBreachProb(sort: Desc)])
  @@index([monthsToWarning])
  @@index([confidenceLevel])
  @@map("contract_risk_scores")
}

model ContractCostObservation {
  id                Int       @id @default(autoincrement())
  contractId        Int       @map("contract_id")
  observationDate   DateTime  @map("observation_date")
  ceilingValue      Decimal   @map("ceiling_value") @db.Decimal(15, 2)
  obligationValue   Decimal   @map("obligation_value") @db.Decimal(15, 2)
  ratio             Decimal   @db.Decimal(8, 4)

  createdAt         DateTime  @default(now()) @map("created_at")

  contract          ServiceContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId, observationDate])
  @@map("contract_cost_observations")
}
